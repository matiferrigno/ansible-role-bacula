---

- name: Install bacula storage
  apt:
    name: "{{ bacula_sd_package_name }}"
    state: present
    install_recommends: false
    update_cache: true
  ignore_errors: true
  no_log: "{{ bacula_no_log|bool }}"

- name: Configure storage
  template:
    src: bacula-sd.conf.j2
    dest: /etc/bacula/bacula-sd.conf
    owner: bacula
    group: tape
    mode: 0640
  notify:
    - Bacula-storage restarted
  no_log: "{{ bacula_no_log|bool }}"

- name: Ensure clients device directories exists
  file:
    path: "{{ bacula_sd_device }}/{{ item.name }}"
    state: directory
    owner: bacula
    group: bacula
    mode: 0740
  when:
    - item.enabled|default(true)|bool
  with_items:
    - "{{ bacula_clients }}"
  notify:
    - Bacula-storage restarted
  no_log: "{{ bacula_no_log|bool }}"

- include_tasks: client-storage-delete.yml
  when:
    - not (item.enabled|default(true)|bool)
  with_items:
    - "{{ bacula_clients }}"

- include_tasks: client-storage-add.yml
  when:
    - item.enabled|default(true)|bool
  with_items:
    - "{{ bacula_clients }}"
