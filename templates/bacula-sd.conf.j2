{% set b_tls %}
{% block tls %}
{% if stg.tls_enabled|default(true)|bool %}
    #########
    ## TLS ##
    #########
    TLS Enable = {{ stg.tls_enabled }}
    TLS Require = {{ stg.tls_require | default(true) }}
    TLS Verify Peer = {{ stg.tls_verify_peer | default(false) }}
    TLS Certificate = {{ stg.tls_certificate | default('/etc/bacula/certs/crt/'+stg.name+'.crt') }}
    TLS Key = {{ stg.tls_key | default('/etc/bacula/certs/crt/'+stg.name+'.pem') }}
    TLS CA Certificate File = {{ stg.ca_certificate | default(bacula_ca_certificate) }}
{% endif %}
{% endblock %}
{% endset %}

###############################
## Auto-generated by:        ##
##         Ansible           ##
## Don't do changes by hand  ##
## Role: matiferrigno.bacula ##
###############################

Storage {

    ###########
    ## Basic ##
    ###########
    Name = {{ stg.name | default('default') }}
    SDPort = {{ stg.port | default(9103) }}
    SDAddress = {{ stg.address | default('0.0.0.0') }}
    WorkingDirectory = {{ stg.working_directory | default('/var/lib/bacula/') }}
    PidDirectory = {{ stg.pid_directory | default('/var/run/bacula/') }}
    Maximum Concurrent Jobs = {{ stg.maximum_concurrent_jobs | default(8) }}

{{ b_tls }}

{% if stg.extra_options|default([]) %}
    ###################
    ## Other options ##
    ###################
  {% for opt in stg.extra_options %}
  {% if opt.enabled|default(true)|bool %}
    {% if opt.comment|d() %}
    {%   for line in opt.comment.split('\n') | list %}
    # {{ line }}
    {%   endfor %}
    {% endif %}
    {{ opt.name }} = {{ opt.value }}
  {% endif %}
  {% endfor %}
{% endif %}
}

Director {
    name = {{ bacula_dir_name }}
    password = "{{ stg.pass | default('changeme!') }}"

{{ b_tls }}

}

Messages {
    Name = {{ bacula_sd_messages }}
    director = {{ bacula_dir_name }} = all
}

########################################
## Include all clients configuration  ##
########################################
@|"find /etc/bacula/devs.d -name '*.conf' -type f -exec echo @{} \;"

